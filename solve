#!/usr/bin/env python

import sys
import z3

from pprint import PrettyPrinter
from typing import List

from src.package import load_dict, parse_repository, parse_command_list, \
                        parse_package_reference
from src.encode import encode, to_bools, GUESS_STEPS
from src.decode import decode
from src.expand import expand_reference, expand_repository, expand_commands
# from src.compare import flatten_repository, parse_constraints


def main(argv: List[str]):
    # Argparse
    repository_path = argv[1]
    initial_state_path = argv[2]
    constraints_path = argv[3]

    # Parse repo
    print('1. parse repo')
    raw_repo = load_dict(repository_path)
    unexpanded_packages = parse_repository(raw_repo)
    packages = expand_repository(unexpanded_packages)
    # packages = flatten_repository(packages)

    # Parse constraints
    print('2. parse final state')
    raw_constraints = load_dict(constraints_path)
    unexpanded_final_state_constraints = parse_command_list(raw_constraints)
    final_state_constraints = list(expand_commands(unexpanded_packages, unexpanded_final_state_constraints))

    print('3. parse initial state')
    raw_initial = load_dict(initial_state_path)
    initial_state = list(map(lambda r: expand_reference(packages, r), map(parse_package_reference, raw_initial)))

    pprinter = PrettyPrinter(indent=2, depth=32)
    print('PACKAGES')
    pprinter.pprint(packages)
    print('=============')
    print('INITIAL STATE CONSTRAINTS')
    pprinter.pprint(initial_state)
    print('=============')
    print('FINAL STATE CONSTRAINTS')
    pprinter.pprint(final_state_constraints)
    print('=============')

    print('MODEL')
    print('5. encode')
    bools = to_bools(packages, range(GUESS_STEPS))
    problem = encode(packages, initial_state, final_state_constraints, bools)
    print('5. check')
    was_sat = problem.check()
    if was_sat == z3.sat:
        model = problem.model()
        print(model)
        print('COMMANDS')
        print('5. decode')
        commands = decode(model, bools, packages)
        print(list(map(str, commands)))
        # print('=============')
    elif was_sat == z3.unknown:
        print('Unknown')
    else:
        print('Impossible')
    print('=============')


if __name__ == '__main__':
    main(sys.argv)
